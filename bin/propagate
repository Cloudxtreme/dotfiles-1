#!/bin/sh

# Send dotfiles and stuff to another host.
# Usage: propagate joseph@some-host.example.com

TARG=$1
if [ -z $TARG ];then
  echo "Please specify user@host."
  exit
fi

echo "Appending SSH key for $TARG..."
KEYCODE=`cat ~/.ssh/id_rsa.pub`
KEYFILE="~/.ssh/authorized_keys"
PROPACMD="if ! [ -d ~/.ssh ]; then \
    mkdir -p ~/.ssh; \
    chmod 700 ~/.ssh; \
  fi; \
  if ! [ -f $KEYFILE ]; then \
    touch $KEYFILE; \
    chmod 644 $KEYFILE; \
  fi; \
  if ! \`grep -q \"$KEYCODE\" $KEYFILE\`; then \
    echo '$KEYCODE' >> $KEYFILE; \
  fi"
ssh -q $TARG "$PROPACMD"

echo "Uploading dotfiles..."
scp -r ~/.bash_profile \
       ~/.bash_aliases \
       ~/.bash_functions \
       ~/.vimrc \
       ~/.irbrc \
       ~/.gitconfig \
       $TARG:~/

echo "Logging in..."
ssh $TARG
